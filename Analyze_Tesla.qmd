---
title: "Analyze Tesla"
author: "Alan Jackson"
format: html
editor: visual
---

## Analyze Tesla data

The tesla data comes from several sources, so we will compare and contrast.

We have the original solar panels, which are on one account, the new solar
panels and batteries, on a different account, and for both we have data
downloaded from the app as well as data downloaded with python code off
the web.

```{r init}
#| echo: false

library(tidyverse)
library(lubridate)

path <- "/home/ajackson/Dropbox/Rprojects/Tulane_Solar/Data/"

Solar_old <- readRDS(paste0(path, "Solar_old.rds"))
Solar_new <- readRDS(paste0(path, "Solar_new.rds"))
App_old <- readRDS(paste0(path, "App_old.rds"))
App_new <- readRDS(paste0(path, "App_new.rds"))

```

##        Make some plots

```{r first plots}

#   Solar_old June 2019, December 2022

Solar_old %>% 
  filter((month(Timestamp)==6) & (year(Timestamp)==2019)) %>% 
  filter(day(Timestamp)<8) %>% 
  ggplot(aes(x=Timestamp, y=Solar_W)) +
  #geom_point()+
  geom_line()

Solar_old %>% 
  filter((month(Timestamp)==12) & (year(Timestamp)==2022)) %>% 
  filter(day(Timestamp)<8) %>% 
  ggplot(aes(x=Timestamp, y=Solar_W)) +
  #geom_point()+
  geom_line()

App_old_sub <- App_old %>%
  filter((month(Date)==12) & (year(Date)==2022)) %>%
  filter(day(Date)<8) %>%
  mutate(Solar=Solar*1000)
  
App_new_sub <- App_new %>% 
  filter((month(Date)==12) & (year(Date)==2022)) %>% 
  filter(day(Date)<8) %>% 
  mutate(Solar=Solar*1000)

Solar_new_sub <- Solar_new %>% 
  filter((month(Timestamp)==12) & (year(Timestamp)==2022)) %>% 
  filter(day(Timestamp)<8)  

Solar_old %>% 
  filter((month(Timestamp)==12) & (year(Timestamp)==2022)) %>% 
  filter(day(Timestamp)<8) %>% 
  ggplot(aes(x=Timestamp, y=Solar_W)) +
  #geom_point()+
  geom_line(size=1.5) +
  geom_line(data=Solar_new_sub, aes(x=Timestamp, y=Solar_W), 
            size=1.5,
            color="red") +
  geom_line(data=App_new_sub, aes(x=Date, y=Solar), color="blue")+
  geom_line(data=App_old_sub, aes(x=Date, y=Solar), color="green")




```

## Plots of the old panel history

```{r old history}

Solar_max_old <- Solar_old %>% 
  mutate(Date=date(Timestamp)) %>% 
  group_by(Date) %>% 
     summarise(Max=max(Solar_W))

Solar_max_old %>% 
  ggplot(aes(x=Date, y=Max)) + 
  geom_point(size=0.5) +
  labs(title="Original Solar Panels - Max Daily Output",
       subtitle="Some panels were removed from July 2021-October 2022",
       x="Date",
       y="Max Output in Watts")

Solar_max_old %>% 
  filter((month(Date)%in%c(8)) & (year(Date)==2021)) %>% 
  filter(day(Date)>16) %>%   
  ggplot(aes(x=Date, y=Max)) + 
  geom_point(size=0.5) +
  geom_line()+
  labs(title="Original Solar Panels - Max Daily Output",
       x="Date",
       y="Max Output in Watts")

Solar_max_old %>% 
  filter((month(Date)%in%c(9,10)) & (year(Date)==2022)) %>% 
  #filter(day(Date)>16) %>%   
  ggplot(aes(x=Date, y=Max)) + 
  geom_point(size=0.5) +
  geom_line()+
  labs(title="Original Solar Panels - Max Daily Output",
       x="Date",
       y="Max Output in Watts")
  

```

## Plots of the new panel history

```{r new history}

Solar_new %>% 
  filter(Timestamp>mdy("11-26-2022")) %>% 
  pivot_longer(!Timestamp, names_to = "Name", values_to = "Value") %>% 
  mutate(Value=Value/1000) %>% 
  ggplot(aes(x=Timestamp, y=Value, color=Name, group=Name))+
  geom_line()+
  labs(title="Energy flows - Positive Numbers Imply Electricity Flowing From",
       x="Date",
       y="Power in kW")

mult <- function(a){a/1000}

foo <- Solar_new %>% 
  filter(date(Timestamp)==mdy("12-01-2022")) %>% 
  rename(Date=Timestamp, Solar=Solar_W, Powerwall=Battery_W, Grid=Grid_W) %>% 
  mutate(across(2:4,mult)) %>% 
  mutate(Source="Web")
  
foo <- App_new %>% 
  filter(date(Date)==mdy("12-01-2022")) %>% 
  mutate(Source="App") %>% 
  select(Date, Solar, Powerwall, Grid, Source) %>% 
  rbind(., foo)

foo %>% 
  mutate(House=Grid + Solar + Powerwall) %>% 
  pivot_longer(!c(Date, Source), names_to = "Name", values_to = "Value") %>% 
  ggplot(aes(x=Date, y=Value, color=Name))+
    geom_line()+
    facet_wrap(vars(Source), nrow=2)


```

##        Calculate $ saved just for grins

```{r dollars}

#   Need to integrate data to get kWh

#   Get test day

Solar_test <- Solar_new %>% 
  filter(date(Timestamp) == mdy("12-01-2022")) %>% 
  mutate(Hour=hour(Timestamp) + minute(Timestamp)/15*0.25)


DescTools::AUC(Solar_test$Hour, Solar_test$Solar_W, method="trapezoid")
DescTools::AUC(Solar_test$Hour, Solar_test$Solar_W, method="spline")

#   Let's look at the whole enchilada

foo <- Solar_old %>% 
  mutate(Hour=hour(Timestamp) + minute(Timestamp)/15*0.25)

Total_kWatts <- 
  DescTools::AUC(foo$Hour, foo$Solar_W, method="trapezoid")

Total_dollars <- Total_kWatts*0.125

# Find max day

Solar_new %>% 
  arrange(Timestamp) %>% 
  mutate(Hour=hour(Timestamp) + minute(Timestamp)/15*0.25 + 0.125) %>% 
  mutate(Date=date(Timestamp)) %>% 
  group_by(Date) %>% 
    summarize(kWh=DescTools::AUC(Hour, Solar_W, method="spline")) %>% 
  mutate(kWh=0.001*kWh,
         Dollars=kWh*0.125) %>% 
  mutate(Cum_kWh=cumsum(kWh)) %>% 
  filter(Cum_kWh>0) %>% 
  ggplot(aes(x=Date, y=Cum_kWh)) +
  geom_line() +
  labs(title="Cumulative kWh Generated by Solar Panels",
       y="Cumulative kWh",
       x="Date")

Solar_old %>% 
  arrange(Timestamp) %>% 
  mutate(Hour=hour(Timestamp) + minute(Timestamp)/15*0.25 + 0.125) %>% 
  mutate(Date=date(Timestamp)) %>% 
  group_by(Date) %>% 
    summarize(kWh=DescTools::AUC(Hour, Solar_W, method="spline")) %>% 
  mutate(kWh=0.001*kWh,
         Dollars=kWh*0.125) %>% 
  mutate(Cum_kWh=cumsum(kWh)) %>% 
  ggplot(aes(x=Date, y=Cum_kWh)) +
  geom_line()+
  labs(title="Cumulative kWh Generated by Solar Panels",
       y="Cumulative kWh",
       x="Date")


```








